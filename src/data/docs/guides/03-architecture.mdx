---
title: 'Architecture'
slug: 'architecture'
section: guides
---

import Code from '@/components/code.astro';

Understand how Haloy's components work together to manage your deployments.

## System Components

Haloy consists of several components working in harmony:

1. **Haloy CLI (`haloy`)** - Command-line interface for deployments from your local machine
2. **Haloy Admin CLI (`haloyadm`)** - Setup and administration tool for the server
3. **Haloy Daemon (`haloyd`)** - Service discovery, configuration, and container orchestration
4. **HAProxy** - External load balancer for SSL termination and traffic routing
5. **Application Containers** - Your deployed applications orchestrated by `haloyd`

## Component Overview

### Haloy CLI (haloy)

**Runs on**: Your local development machine

**Purpose**: Trigger deployments and manage applications

**Key Functions**:

- Read and validate configuration files
- Build Docker images locally (optional)
- Upload images to servers
- Send deployment commands to `haloyd` API
- Display deployment status and logs

**Location**: `~/.local/bin/haloy`

### Haloy Admin CLI (haloyadm)

**Runs on**: Your server

**Purpose**: Set up and administrate the Haloy daemon

**Key Functions**:

- Initialize `haloyd` and HAProxy
- Start/stop/restart services
- Generate API tokens
- Configure API domains and SSL

**Location**: `/usr/local/bin/haloyadm` (system) or `~/.local/bin/haloyadm` (user)

### Haloy Daemon (haloyd)

**Runs on**: Your server (as a Docker container)

**Purpose**: Container orchestration and service discovery

**Key Functions**:

- Accept deployment commands via REST API
- Pull or load Docker images
- Start and stop application containers
- Monitor container health
- Generate HAProxy configuration dynamically
- Manage SSL certificates via ACME (Let's Encrypt)
- Track deployment history for rollbacks

**Runs as**: Docker container managed by systemd

**Configuration**: `/etc/haloy/haloyd.yaml` or `~/.config/haloy/haloyd.yaml`

**Data storage**: `/var/lib/haloy/` or `~/.local/share/haloy/`

### HAProxy

**Runs on**: Your server (as a Docker container)

**Purpose**: Load balancing and SSL termination

**Key Functions**:

- Route external traffic to application containers
- SSL/TLS termination
- HTTP to HTTPS redirects
- Domain routing
- Load balancing across replicas
- Health check integration

**Runs as**: Docker container managed by systemd

**Configuration**: Auto-generated by `haloyd`

**Listens on**: Ports 80 (HTTP) and 443 (HTTPS)

### Application Containers

**Runs on**: Your server

**Purpose**: Your deployed applications

**Managed by**: `haloyd`

**Networking**: Connected to Haloy's Docker network

**Health monitoring**: Via configured health check endpoints

## Architecture Diagram

<Code
  code={`┌─────────────────────┐
│  Developer Machine  │
│                     │
│  ┌──────────────┐   │
│  │ haloy CLI    │   │
│  └──────┬───────┘   │
└─────────┼───────────┘
          │ HTTPS
          │ (API calls)
          ▼
┌─────────────────────────────────────────┐
│              Server                     │
│                                         │
│  ┌──────────────────┐                   │
│  │ haloyd (Docker)  │◄──systemd         │
│  │                  │                   │
│  │ - API Server     │                   │
│  │ - Orchestration  │                   │
│  │ - Service Disc.  │                   │
│  └────┬─────────────┘                   │
│       │ Generates                       │
│       │ config                          │
│       ▼                                 │
│  ┌──────────────────┐                   │
│  │ HAProxy (Docker) │◄──systemd         │
│  │                  │                   │
│  │ Ports: 80, 443   │                   │
│  └────┬─────────────┘                   │
│       │ Routes traffic                  │
│       │                                 │
│       ├──────────┬──────────┐           │
│       ▼          ▼          ▼           │
│  ┌────────┐ ┌────────┐ ┌────────┐      │
│  │ App    │ │ App    │ │ App    │      │
│  │ (8080) │ │ (8080) │ │ (8080) │      │
│  └────────┘ └────────┘ └────────┘      │
│   Replica 1  Replica 2  Replica 3      │
└─────────────────────────────────────────┘`}
  lang="text"
/>

## Traffic Flow

### Incoming Requests

<Code
  code={`1. Internet
   │
   ├─ HTTP (port 80)
   │  └─► HAProxy → Redirects to HTTPS
   │
   └─ HTTPS (port 443)
      └─► HAProxy
          ├─ SSL Termination
          ├─ Domain Routing (my-app.com → my-app)
          └─► Load Balance
              ├─► App Container 1 (port 8080)
              ├─► App Container 2 (port 8080)
              └─► App Container 3 (port 8080)`}
  lang="text"
/>

### Deployment Flow

<Code
  code={`1. Developer: haloy deploy
   │
   └─► Build image locally (if configured)
       │
       └─► Upload to server or push to registry
           │
           └─► API call to haloyd
               │
               ├─► haloyd pulls/loads image
               ├─► haloyd starts new containers
               ├─► haloyd waits for health checks
               ├─► haloyd updates HAProxy config
               ├─► HAProxy routes to new containers
               └─► haloyd stops old containers`}
  lang="text"
/>

## Service Discovery

Haloy uses Docker labels for service discovery:

<Code
  code={`# Example container labels
haloy.app=my-app
haloy.domain=my-app.com
haloy.port=8080
haloy.health_check_path=/health`}
  lang="text"
/>

**Process**:

1. `haloyd` monitors Docker for labeled containers
2. Extracts routing information from labels
3. Generates HAProxy configuration
4. Reloads HAProxy with zero downtime

## Networking

### Docker Networks

Haloy creates and uses Docker networks:

- **haloy-public** (default): Application containers and HAProxy
- Custom networks: Via `network` configuration option

### Port Mapping

<Code code={`HAProxy:
  - 80:80   (HTTP)
  - 443:443 (HTTPS)

Application Containers:

- No direct port exposure
- Internal network only
- HAProxy routes traffic`} lang="text" />

## Data Storage

### System Installation

<Code code={`/etc/haloy/
├── haloyd.yaml          # Daemon configuration
└── .env                 # API tokens

/var/lib/haloy/
├── haproxy-config/ # HAProxy configurations
├── cert-storage/ # SSL certificates
└── db/ # Deployment database`} lang="text" />

### User Installation

<Code code={`~/.config/haloy/
├── haloyd.yaml          # Daemon configuration
└── .env                 # API tokens

~/.local/share/haloy/
├── haproxy-config/ # HAProxy configurations
├── cert-storage/ # SSL certificates
└── db/ # Deployment database`} lang="text" />

## SSL/TLS Certificates

**Certificate Management**:

- Automatic via ACME (Let's Encrypt)
- Certificates stored in `cert-storage/`
- Auto-renewal before expiration
- Per-domain certificates

**Process**:

1. Domain configured in `haloy.yaml`
2. `haloyd` requests certificate from Let's Encrypt
3. ACME challenge validation (HTTP-01)
4. Certificate issued and stored
5. HAProxy configured to use certificate
6. Auto-renewal 30 days before expiration

## Health Checks

**Flow**:

<Code
  code={`HAProxy → Health Check → App Container (/health endpoint)
   │                              │
   │                              ├─ 200 OK → Healthy
   │                              └─ Other → Unhealthy
   │
   └─ Routes traffic only to healthy containers`}
  lang="text"
/>

**Check Frequency**: Every few seconds

**Actions on Failure**:

- Container marked unhealthy
- Traffic stops routing to container
- Container visible in `haloy status` as unhealthy

## High Availability

Haloy achieves HA through:

1. **Multiple replicas**: Run 3+ instances
2. **Health monitoring**: Remove unhealthy containers from rotation
3. **Rolling deployments**: Update without downtime
4. **Load balancing**: Distribute traffic evenly
5. **Automatic recovery**: Restart failed containers

## Deployment Strategies

### Rolling Deployment

<Code
  code={`Old containers: [1] [2] [3]
                 │   │   │
Step 1:          │   │   │  New [1] starts
Step 2:          │   │   │  New [1] healthy → Old [1] stops
Step 3:          │   │   │  New [2] starts
Step 4:          │   │   │  New [2] healthy → Old [2] stops
Step 5:          │   │   │  New [3] starts
Step 6:          │   │   │  New [3] healthy → Old [3] stops
                 ▼   ▼   ▼
New containers: [1] [2] [3]`}
  lang="text"
/>

### Replace Deployment

<Code
  code={`Old containers: [1] [2] [3]
                 │   │   │
Step 1:          Stop all old containers
Step 2:          Start all new containers
Step 3:          Wait for health checks
                 ▼   ▼   ▼
New containers: [1] [2] [3]`}
  lang="text"
/>

## Security

**API Authentication**:

- API tokens generated by `haloyadm`
- Tokens stored securely with restrictive permissions
- HTTPS for all API communication (when domain configured)

**Container Isolation**:

- Docker network isolation
- No direct container exposure to internet
- All traffic through HAProxy

**SSL/TLS**:

- Automatic certificate management
- Strong cipher suites
- HTTP to HTTPS redirect

## Scalability

**Horizontal Scaling**:

- Add more replicas in configuration
- Load balanced automatically
- Linear scaling for stateless apps

**Multi-Server**:

- Deploy to multiple servers
- Independent server scaling
- Geographic distribution

## Monitoring

**Built-in Monitoring**:

- Container health checks
- Deployment status tracking
- Application logs via `haloy logs`
- Service status via `haloy status`

**External Monitoring**:

- Expose health check endpoints
- Monitor via Prometheus/Grafana
- Alert on health check failures

## Limitations

1. **Single server orchestration**: Each server managed independently
2. **No automatic scaling**: Manual replica configuration
3. **No built-in monitoring**: Use external tools
4. **Docker required**: All components run in Docker
5. **Linux only**: Server must be Linux-based

## Next Steps

- [Learn about Multi-Server Deployments](/docs/multi-server-deployments)
- [Configure Health Checks](/docs/deployment-strategies#health-checks)
- [Set up Horizontal Scaling](/docs/scaling)
- [Understand Authentication](/docs/authentication)
